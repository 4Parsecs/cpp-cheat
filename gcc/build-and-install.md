# Build and install

Tested with: version 5.1.0 on Ubuntu 14.04 in a 2013 computer.

Summary:

    apt-get install flex bison
    git clone git://gcc.gnu.org/git/gcc.git
    cd gcc
    # No annotated tags... so no describe.
    git checkout gcc-5_1_0-release
    ./contrib/download_prerequisites
    cd ..
    mkdir gcc-build
    cd gcc-build
    ../gcc/configure --enable-languages=c,c++
    make
    sudo make install

## Configure

### download_prerequisites

In Ubuntu 14.04, missing dependencies GMP and others did not go away for me even though they were installed with `apt-get build-dep gcc` and `dpkg` says they are present. I needed `download_prerequisites`

<http://stackoverflow.com/questions/9253695/building-gcc-requires-gmp-4-2-mpfr-2-3-1-and-mpc-0-8-0>

Also `configure` does not detect a missing `flex`, but it seems required or else you get a missing `yylex` error: <http://stackoverflow.com/questions/4262531/trouble-building-gcc-4-6>

### Binutils and GCC

Binutils a requirement of GCC. For instance, Linux From Scratch first installs Binutils, then GCC, then recompiles both to bootstrap.

It appears that you can build both GCC and Binutils the same time: <http://stackoverflow.com/questions/1726042/recipe-for-compiling-binutils-gcc-together>

A compatibility matrix between GCC and Binutils can be found at: <http://wiki.osdev.org/Cross-Compiler_Successful_Builds>

### glibc and GCC

GCC depends on glibc. TODO does it depend on `stdlibc++`?

Linux From Scratch compiles it twice to bootstrap.

### Three systems

When you build GCC, you have to configure 3 systems:

- build: where GCC will be built
- host: the system that will run GCC
- target: the system that will run the code generated by the compiled GCC

<https://gcc.gnu.org/onlinedocs/gcc-5.1.0/gccint/Configure-Terms.html#Configure-Terms>

## Build

Making a separate build directory is mandatory.

Took me 2 hours on a and 4GB of disk.

To build only certain parts of GCC <http://stackoverflow.com/questions/14728652/how-to-make-a-light-build-of-gcc-with-language-supports-etc-pruned>:

    ../gcc/configure --enable-languages=c,c++

With `make -j5`, this took 1 hour.

See all configuration options with:

    ./configure --help

### bootstrap

### Build stages

By default, the build happens in 3 stages:

1. compile the compiler with the compiler of the `build` computer
2. use the compiled compiler to compile itself
3. repeat 2. and compare 2 and 3. Should be the same.

Configure the build to disable bootstrap and compile only once:

    ../gcc/configure --disable-bootstrap

TODO does it work without? Is bootstrap really necessary? How can stage 3 ever be different from stage 2?

## Tests

    sudo apt-get install autogen runtest

Run all tests:

    make -k check

Run only certain tests:

    make -k check-gcc-c
    make -k check-gcc

## Install

Generated files will be put under:

- `/usr/local/bin` for font-end executables like `gcc`, `ld`
- `/usr/local/lib64` for libraries like `libstdc++`
- `/usr/local/libexec/gcc/x86_64-unknown-linux-gnu/5.1.0` for backend executables like `cc1` and `collect2`

## Run what you've built

TODO what is the required glibc for each GCC?

C programs seemed to run directly:

    gcc hello_world.c
    ./hello_world

On Ubuntu 14.04, GCC 5.1, C++ programs needed `$LD_LIBRARY_PATH` to find the standard library `libstdc++.so` as it is not on the path by default:

    LD_LIBRARY_PATH="/usr/local/lib64:$LD_LIBRARY_PATH" ./cpp

## Modify, rebuild and rerun

Modify a single line under on the `gcc` entry point `gcc/gcc-main.c`:

    #include <stdio.h>

    fputs("hacked\n", stderr);

You *cannot* modify the *stdout* output, or else the build will fail! This probably happens because `dumpspecs` is used on some part of the bootstrap process.

In general, even writing to stderr could make tests fail however: the safest thing possible would be to write any outputs to a file, or use a debugger.

Then on the build directory:

    make -j5
    sudo make install

And now any invocation of `gcc` should output `hacked` before anything else:

    gcc -v

## Uninstall

    cd gcc
    sudo make uninstall

## Documentation

    make

builds `man` and `info` documentation by default:

    cd gcc/doc
    man ./gcc.1

Those are generated from the `.texi` inputs.

For the HTML docs, use:

    make html

    firefox/gcc/HTML/gcc-4.8.2/gcc/index.html

The website is not included in the source code, but on a separate repo:

    cvs -q -d :pserver:cvs@gcc.gnu.org:/cvs/gcc checkout -P wwwdocs
